
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Hut Map with Mapy.cz Outdoor</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 20px;
      bottom: 20px;
      left: 20px;
      right: 20px;
      border-radius: 10px;
      border: 2px solid #ccc;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table {
      font-size: 12px;
      border-collapse: collapse;
      margin-top: 5px;
    }
    th, td {
      padding: 3px 5px;
      border: 1px solid #aaa;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script>
  const API_KEY = 'pc91XiwJPo2njuX7suddXA0pXNS3veXA7vM5KRC3CRI';

  const map = L.map('map').setView([47.5, 13.3], 8);

  const tileLayers = {
    'Outdoor': L.tileLayer(`https://api.mapy.cz/v1/maptiles/outdoor/256/{z}/{x}/{y}?apikey=${API_KEY}`, {
      minZoom: 0,
      maxZoom: 19,
      attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s.</a>'
    }),
    'Winter': L.tileLayer(`https://api.mapy.cz/v1/maptiles/winter/256/{z}/{x}/{y}?apikey=${API_KEY}`),
    'Aerial': L.tileLayer(`https://api.mapy.cz/v1/maptiles/aerial/256/{z}/{x}/{y}?apikey=${API_KEY}`),
    'Basic': L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}`)
  };

  tileLayers['Outdoor'].addTo(map);
  L.control.layers(tileLayers).addTo(map);

  const LogoControl = L.Control.extend({
    options: { position: 'bottomleft' },
    onAdd: function () {
      const container = L.DomUtil.create('div');
      const link = L.DomUtil.create('a', '', container);
      link.href = 'https://mapy.cz/';
      link.target = '_blank';
      link.innerHTML = '<img src="https://api.mapy.cz/img/api/logo.svg" />';
      L.DomEvent.disableClickPropagation(link);
      return container;
    }
  });
  new LogoControl().addTo(map);

  fetch('huts_with_coords.json')
    .then(res => res.json())
    .then(huts => {
      huts.forEach(hut => {
        if (!hut.lat || !hut.lng) return;
        const marker = L.marker([hut.lat, hut.lng]).addTo(map);
        marker.bindPopup(`<b>${hut.hutName}</b><br><em>Loading availability...</em>`);
        marker.on('click', () => {
          fetch(`/api/availability/${hut.hutId}`)
           .then(data => {
            let html = `<b>${hut.hutName}</b><br><div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:5px;">`;
            data.forEach(day => {
                const beds = day.freeBeds;
                let color = beds > 30 ? 'green' : beds > 10 ? 'orange' : 'red';
                html += `
                <div style="
                    background:${color}; 
                    color:white; 
                    width:32px; 
                    height:32px; 
                    border-radius:50%; 
                    display:flex; 
                    align-items:center; 
                    justify-content:center; 
                    font-size:12px;
                    font-weight:bold;
                    flex-direction:column;
                " title="${day.dateFormatted}">
                    ${new Date(day.dateFormatted).getDate()}
                </div>`;
            });
            html += "</div>";

            marker.getPopup().setContent(html).update();
            }) 
        });
      });
    });
</script>
</body>
</html>
